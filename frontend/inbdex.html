<!DOCTYPE html>
<html>
  <head>
    <title>Advanced Geofence Demo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* All your beautiful CSS from before remains the same... */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        min-height: 100vh;
        display: flex;
        gap: 20px;
        color: #e2e8f0;
      }
      #main-content {
        flex-grow: 1;
      }
      #map {
        height: 100%;
        min-height: 600px;
        border: 2px solid #4c1d95;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(76, 29, 149, 0.3);
        overflow: hidden;
      }
      #control-panel {
        flex-shrink: 0;
        width: 320px;
        padding: 24px;
        background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      }
      #control-panel h3 {
        margin-top: 0;
        margin-bottom: 24px;
        border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        padding-bottom: 12px;
        font-size: 20px;
        font-weight: 600;
        color: #c4b5fd;
        text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
      }
      .control-button {
        display: block;
        width: 100%;
        padding: 14px 20px;
        margin-bottom: 12px;
        font-size: 15px;
        font-weight: 500;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        font-family: inherit;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #8b5cf6 0%, #c084fc 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(124, 58, 237, 0.6);
      }
      .btn-secondary {
        background: linear-gradient(135deg, #4c1d95 0%, #6b21a8 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(76, 29, 149, 0.4);
      }
      .btn-secondary:hover {
        background: linear-gradient(135deg, #5b21b6 0%, #7e22ce 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(76, 29, 149, 0.6);
      }
      .btn-success {
        background: linear-gradient(135deg, #059669 0%, #10b881 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
      }
      .btn-success:hover {
        background: linear-gradient(135deg, #047857 0%, #059669 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(5, 150, 105, 0.6);
      }
      .control-button:disabled {
        background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .dropdown {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      #draw-options {
        display: none;
        position: absolute;
        background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%);
        width: 100%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 8px;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      #draw-options.show {
        display: block;
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      #draw-options a {
        color: #e2e8f0;
        padding: 14px 20px;
        text-decoration: none;
        display: block;
        transition: all 0.3s ease;
        position: relative;
        font-weight: 500;
      }
      #draw-options a:hover {
        background: rgba(139, 92, 246, 0.2);
        color: #c4b5fd;
        padding-left: 24px;
      }
      #status-indicator {
        margin-top: 24px;
        padding: 16px;
        background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
        border-radius: 12px;
        text-align: center;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }
      #status-indicator strong,
      #output-container strong {
        color: #c4b5fd;
      }
      #statusText {
        color: #8b5cf6;
        font-weight: 600;
      }
      #output-container {
        margin-top: 24px;
        height: 150px;
        overflow-y: auto;
        border: 2px solid rgba(139, 92, 246, 0.3);
        padding: 16px;
        border-radius: 12px;
        background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-size: 12px;
        color: #94a3b8;
        line-height: 1.5;
      }
      hr {
        border: none;
        height: 2px;
        background: linear-gradient(90deg, transparent, #8b5cf6, transparent);
        margin: 24px 0;
        border-radius: 1px;
      }
      /* NEW: Styles for the Business Name Input */
      .business-name-input {
        width: 100%;
        padding: 14px 20px;
        margin-bottom: 20px;
        border: 2px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.3s ease;
        outline: none;
      }
      .business-name-input:focus {
        border-color: #7c3aed;
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
      }
      .business-name-input::placeholder {
        color: #64748b;
      }
    </style>
  </head>
  <body>
    <div id="control-panel">
      <h3>üìç Geofence Editor</h3>

      <div class="dropdown">
        <button id="drawMenuBtn" class="control-button btn-primary">
          Draw New Geofence ‚ñº
        </button>
        <div id="draw-options">
          <a href="#" data-shape="polygon">üî∑ Polygon</a>
          <a href="#" data-shape="rectangle">‚¨ú Rectangle</a>
          <a href="#" data-shape="circle">‚≠ï Circle</a>
        </div>
      </div>

      <button id="editBtn" class="control-button btn-secondary" disabled>
        ‚úèÔ∏è Edit Shape
      </button>
      <button id="clearBtn" class="control-button btn-secondary" disabled>
        üóëÔ∏è Clear Shape
      </button>
      <hr />

      <input
        type="text"
        id="businessNameInput"
        class="business-name-input"
        placeholder="Enter Business Name..."
        disabled
      />

      <button id="submitBtn" class="control-button btn-success" disabled>
        üöÄ Final Submit
      </button>

      <div id="status-indicator">
        <strong>Status:</strong> <span id="statusText">Idle</span>
      </div>

      <div id="output-container">
        <strong>GeoJSON Output:</strong>
        <pre id="output">No shape drawn yet.</pre>
      </div>
    </div>

    <div id="main-content">
      <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
      // --- 1. SETUP ---
      var map = L.map("map").setView([13.0827, 80.2707], 13);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
        }
      ).addTo(map);

      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControlOptions = {
        draw: {
          polygon: {
            shapeOptions: {
              color: "#8b5cf6",
              weight: 3,
              fillColor: "#7c3aed",
              fillOpacity: 0.3,
            },
          },
          rectangle: {
            shapeOptions: {
              color: "#10b981",
              weight: 3,
              fillColor: "#059669",
              fillOpacity: 0.3,
            },
          },
          circle: {
            shapeOptions: {
              color: "#f59e0b",
              weight: 3,
              fillColor: "#d97706",
              fillOpacity: 0.3,
            },
          },
        },
        edit: { featureGroup: drawnItems },
      };

      var currentShape = null;
      var drawHandler = null;

      // --- 2. UI ELEMENTS ---
      var drawMenuBtn = document.getElementById("drawMenuBtn"),
        drawOptions = document.getElementById("draw-options"),
        editBtn = document.getElementById("editBtn"),
        clearBtn = document.getElementById("clearBtn"),
        submitBtn = document.getElementById("submitBtn"),
        statusText = document.getElementById("statusText"),
        outputElement = document.getElementById("output"),
        businessNameInput = document.getElementById("businessNameInput");

      // --- 3. HELPER FUNCTIONS ---
      function updateUIState() {
        var hasShape = !!currentShape;
        editBtn.disabled = !hasShape;
        clearBtn.disabled = !hasShape;
        submitBtn.disabled = !hasShape;
        drawMenuBtn.disabled = hasShape;
        businessNameInput.disabled = !hasShape; // Enable/disable name input
      }

      function setStatus(text) {
        statusText.textContent = text;
      }

      function updateOutput(layer) {
        currentShape = layer;
        var geojsonData = layer.toGeoJSON();
        outputElement.innerHTML = JSON.stringify(geojsonData, null, 2);
        updateUIState();
      }

      function resetState() {
        drawnItems.clearLayers();
        currentShape = null;
        outputElement.innerHTML = "No shape drawn yet.";
        businessNameInput.value = ""; // Clear name input
        setStatus("Idle");
        updateUIState();
      }

      // --- 4. EVENT HANDLERS ---
      drawMenuBtn.onclick = function () {
        drawOptions.classList.toggle("show");
      };
      window.onclick = function (event) {
        if (!event.target.matches("#drawMenuBtn")) {
          if (drawOptions.classList.contains("show"))
            drawOptions.classList.remove("show");
        }
      };
      drawOptions.onclick = function (event) {
        event.preventDefault();
        var shape = event.target.dataset.shape;
        if (!shape) return;
        drawOptions.classList.remove("show");
        setStatus(`Drawing ${shape}...`);
        switch (shape) {
          case "polygon":
            drawHandler = new L.Draw.Polygon(
              map,
              drawControlOptions.draw.polygon
            );
            break;
          case "rectangle":
            drawHandler = new L.Draw.Rectangle(
              map,
              drawControlOptions.draw.rectangle
            );
            break;
          case "circle":
            drawHandler = new L.Draw.Circle(
              map,
              drawControlOptions.draw.circle
            );
            break;
        }
        if (drawHandler) drawHandler.enable();
      };
      editBtn.onclick = function () {
        var editHandler = new L.EditToolbar.Edit(map, {
          featureGroup: drawnItems,
        });
        editHandler.enable();
        setStatus("Editing shape...");
      };

      clearBtn.onclick = resetState;

      // UPDATED: submitBtn onclick function
      submitBtn.onclick = function () {
        const businessName = businessNameInput.value.trim();
        const geoJsonFeature = JSON.parse(outputElement.innerHTML);

        if (!businessName) {
          alert("Please enter a business name before submitting.");
          businessNameInput.focus();
          return;
        }

        // The data payload we will send to the backend
        const payload = {
          business_name: businessName,
          geometry: geoJsonFeature.geometry, // We only need the 'geometry' part of the GeoJSON
        };

        // Your live Render backend URL
        const backendUrl =
          "https://vouch-backend-208s.onrender.com/api/geofence";

        if (confirm(`Submit geofence for "${businessName}"?`)) {
          setStatus("Submitting...");
          submitBtn.disabled = true;

          fetch(backendUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((response) => {
              if (!response.ok) {
                // If we get an error response, we parse it as text to show the user
                return response.text().then((text) => {
                  throw new Error(text);
                });
              }
              return response.json();
            })
            .then((data) => {
              alert(`Success! ${data.message} (New ID: ${data.id})`);
              resetState();
            })
            .catch((error) => {
              console.error("Submission Error:", error);
              alert("Submission Failed. Error: " + error.message);
              setStatus("Submission Failed");
              submitBtn.disabled = false; // Re-enable button on failure
            });
        }
      };

      // --- 5. LEAFLET DRAW EVENT LISTENERS ---
      map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
        drawnItems.addLayer(layer);
        updateOutput(layer);
        setStatus("Shape temporarily saved.");
      });
      map.on(L.Draw.Event.EDITED, function (event) {
        var layers = event.layers;
        layers.eachLayer(function (layer) {
          updateOutput(layer);
        });
        setStatus("Edits temporarily saved.");
      });
      map.on("draw:editstop", function () {
        setStatus("Edits temporarily saved.");
      });
      map.on("draw:drawstop", function () {
        if (!currentShape) setStatus("Idle");
      });

      // Initial UI state
      updateUIState();
    </script>
  </body>
</html>
